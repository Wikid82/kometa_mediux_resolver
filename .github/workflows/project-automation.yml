name: Project Board Automation

on:
  issues:
    types: [opened, closed, reopened, assigned]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, converted_to_draft]
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      project_url:
        description: "Override Projects V2 URL (e.g., https://github.com/users/<login>/projects/<num>)"
        required: false
        default: ""

jobs:
  update-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      repository-projects: write
    env:
      PROJECT_URL: ${{ inputs.project_url != '' && inputs.project_url || vars.PROJECT_V2_URL }}
    steps:
    - name: Show chosen project URL
      run: |
        echo "Project URL: $PROJECT_URL"

    - name: Add issue to project
      if: github.event_name == 'issues' && github.event.action == 'opened' && env.PROJECT_URL != ''
      uses: actions/add-to-project@244f685bbc3b7adfa8466e08b698b5577571133e # v1.0.2
      with:
        project-url: ${{ env.PROJECT_URL }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Add PR to project
      if: github.event_name == 'pull_request' && github.event.action == 'opened' && env.PROJECT_URL != ''
      uses: actions/add-to-project@244f685bbc3b7adfa8466e08b698b5577571133e # v1.0.2
      with:
        project-url: ${{ env.PROJECT_URL }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Move issue to In Progress when assigned
      if: github.event_name == 'issues' && github.event.action == 'assigned'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Issue assigned, moving to In Progress')

    - name: Move to Done when issue closed
      if: github.event_name == 'issues' && github.event.action == 'closed'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Issue closed, moving to Done')

    - name: Move PR to Review when ready
      if: github.event_name == 'pull_request' && github.event.action == 'ready_for_review'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('PR ready for review')

    - name: Move PR to Done when merged
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('PR merged, moving to Done')

    - name: Update coverage milestone
      if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('CI completed successfully, checking coverage metrics')
