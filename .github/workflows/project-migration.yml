name: One-Time Project Migration
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (just show what would be added)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  migrate-existing-items:
    runs-on: ubuntu-latest
    name: Add existing issues and PRs to project

    steps:
    - name: Add existing items to project
      uses: actions/add-to-project@v0.6.0
      with:
        project-url: https://github.com/users/Wikid82/projects/3
        github-token: ${{ secrets.PROJECTS_TOKEN }}
        labeled: '' # Add all items regardless of labels

    - name: List items that will be added
      if: github.event.inputs.dry_run == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PROJECTS_TOKEN }}
        script: |
          console.log('ï¿½ DRY RUN MODE - Checking existing items...');

          // Get all open issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            per_page: 100
          });

          // Get all open pull requests
          const prs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            per_page: 100
          });

          console.log(`ï¿½ Found ${issues.data.length} open issues:`);
          issues.data.forEach(issue => {
            console.log(`  - Issue #${issue.number}: ${issue.title}`);
          });

          console.log(`ï¿½ Found ${prs.data.length} open pull requests:`);
          prs.data.forEach(pr => {
            console.log(`  - PR #${pr.number}: ${pr.title}`);
          });

          console.log('');
          console.log('ğŸ’¡ Re-run with dry_run="false" to actually add these items to the project');

    - name: Add items when not in dry run
      if: github.event.inputs.dry_run == 'false'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PROJECTS_TOKEN }}
        script: |
          console.log('ğŸš€ Adding all existing open issues and PRs to project...');
          console.log('ğŸ“‹ The add-to-project action above will handle the actual addition');
          console.log('âœ… Migration initiated - check your project board in a few minutes');

    - name: Instructions for manual verification
      run: |
        echo "ğŸ” Migration process completed!"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Go to https://github.com/users/Wikid82/projects/3"
        echo "2. Verify that issues and PRs were added correctly"
        echo "3. Manually organize items into appropriate columns:"
        echo "   - ğŸ“‹ Backlog (new items)"
        echo "   - ğŸ”„ In Progress (actively working)"
        echo "   - ğŸ” In Review (PRs ready for review)"
        echo "   - ğŸ§ª Testing (ready for testing)"
        echo "   - âœ… Done (completed items)"
        echo ""
        echo "4. Consider deleting .github/workflows/project-migration.yml after successful migration"
