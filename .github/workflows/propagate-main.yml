name: Propagate Main to Development

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  create-propagation-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open PR from main to development
          EXISTING_PR=$(gh pr list --base development --head main --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update PR
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch latest development
          git fetch origin development:development

          # Check if there are differences between main and development
          if git diff --quiet origin/main origin/development; then
            echo "No differences between main and development, skipping PR creation"
            exit 0
          fi

          # Create PR from main to development
          gh pr create \
            --base development \
            --head main \
            --title "chore: propagate main changes to development" \
            --body "This PR automatically propagates changes from \`main\` to \`development\`.

          ## Changes
          $(git log --oneline origin/development..origin/main | head -10)

          **Auto-generated by propagate-main workflow**" \
            --label "automated" \
            --label "propagation"

      - name: Comment on existing PR
        if: steps.check_pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.check_pr.outputs.pr_number }} \
            --body "ðŸ”„ New changes pushed to \`main\` - this PR has been updated.

          Latest commit: ${{ github.sha }}
          Triggered by: ${{ github.event.head_commit.message }}"
