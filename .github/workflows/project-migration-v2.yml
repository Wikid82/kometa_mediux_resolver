name: One-Time Project Migration
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (just show what would be added)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  migrate-existing-items:
    runs-on: ubuntu-latest
    name: Add existing issues and PRs to project

    steps:
    - name: Migrate existing items to project
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const dryRun = '${{ github.event.inputs.dry_run }}' === 'true';

          console.log('üöÄ Starting migration to GitHub Projects...');
          console.log(`üìã Dry run mode: ${dryRun}`);

          try {
            // Get all open issues (excluding PRs)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Filter out pull requests (they show up in issues endpoint)
            const actualIssues = issues.data.filter(issue => !issue.pull_request);

            // Get all open pull requests
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log(`üìù Found ${actualIssues.length} open issues`);
            console.log(`üîÄ Found ${prs.data.length} open pull requests`);

            if (dryRun) {
              console.log('\nüîç DRY RUN - Issues that would be added:');
              actualIssues.forEach(issue => {
                console.log(`  - Issue #${issue.number}: ${issue.title}`);
              });

              console.log('\nüîç DRY RUN - PRs that would be added:');
              prs.data.forEach(pr => {
                console.log(`  - PR #${pr.number}: ${pr.title}`);
              });

              console.log('\nüí° To actually migrate items, re-run with dry_run="false"');
              return;
            }

            // Get project ID using GraphQL
            const projectQuery = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }
            `;

            const projectResult = await github.graphql(projectQuery, {
              owner: context.repo.owner,
              number: 3
            });

            const projectId = projectResult.user.projectV2.id;
            console.log(`üìã Project ID: ${projectId}`);

            let successCount = 0;
            let errorCount = 0;

            // Add issues to project
            for (const issue of actualIssues) {
              try {
                console.log(`‚ûï Adding issue #${issue.number}: ${issue.title}`);

                const addMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2Item(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `;

                await github.graphql(addMutation, {
                  projectId: projectId,
                  contentId: issue.node_id
                });

                console.log(`‚úÖ Added issue #${issue.number}`);
                successCount++;

              } catch (error) {
                if (error.message.includes('already exists')) {
                  console.log(`‚ö†Ô∏è Issue #${issue.number} already in project`);
                } else {
                  console.log(`‚ùå Failed to add issue #${issue.number}: ${error.message}`);
                  errorCount++;
                }
              }
            }

            // Add PRs to project
            for (const pr of prs.data) {
              try {
                console.log(`‚ûï Adding PR #${pr.number}: ${pr.title}`);

                const addMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2Item(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `;

                await github.graphql(addMutation, {
                  projectId: projectId,
                  contentId: pr.node_id
                });

                console.log(`‚úÖ Added PR #${pr.number}`);
                successCount++;

              } catch (error) {
                if (error.message.includes('already exists')) {
                  console.log(`‚ö†Ô∏è PR #${pr.number} already in project`);
                } else {
                  console.log(`‚ùå Failed to add PR #${pr.number}: ${error.message}`);
                  errorCount++;
                }
              }
            }

            console.log('\nüìà Migration Summary:');
            console.log(`  ‚úÖ Successfully added: ${successCount}`);
            console.log(`  ‚ùå Failed to add: ${errorCount}`);
            console.log(`  üìä Total items: ${actualIssues.length + prs.data.length}`);

          } catch (error) {
            console.log(`üí• Migration failed: ${error.message}`);
            core.setFailed(`Migration failed: ${error.message}`);
          }

    - name: Instructions for next steps
      run: |
        echo "üéâ Migration completed!"
        echo ""
        echo "üìã Next steps:"
        echo "1. Go to https://github.com/users/Wikid82/projects/3"
        echo "2. Check that all items were added to the project"
        echo "3. Organize items into appropriate columns:"
        echo "   - üìã Todo/Backlog (default location for new items)"
        echo "   - üîÑ In Progress (actively working)"
        echo "   - üîç In Review (PRs ready for review)"
        echo "   - üß™ Testing (ready for testing)"
        echo "   - ‚úÖ Done (completed items)"
        echo ""
        echo "üí° You can delete this migration workflow after successful completion"
